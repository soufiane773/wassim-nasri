<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Search Results - LuxeVault</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: "#ff8c00", secondary: "#4caf50" },
          borderRadius: {
            none: "0px",
            sm: "4px",
            DEFAULT: "8px",
            md: "12px",
            lg: "16px",
            xl: "20px",
            "2xl": "24px",
            "3xl": "32px",
            full: "9999px",
            button: "8px",
          },
        },
      },
    };
  </script>
</head>
<body class="bg-black">
  <header class="header sticky top-0 z-50 bg-black shadow-sm">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <!-- Logo -->
      <a href="index.html" class="logo font-['Pacifico'] text-3xl text-primary">LuxeVault</a>

      <!-- Search Bar -->
      <div class="search-bar hidden md:flex items-center flex-1 max-w-xl mx-6">
        <div class="relative w-full">
          <input
            type="text"
            id="search-input"
            class="search-input w-full py-2 pl-10 pr-4 rounded-full border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary bg-gray-800 text-white"
            placeholder="Discover luxury items..."
            aria-label="Search for products"
          />
          <div
            class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 flex items-center justify-center text-gray-400"
          >
            <i class="ri-search-line" aria-hidden="true"></i>
          </div>
        </div>
      </div>

      <!-- Right Navigation Icons -->
      <div class="flex items-center space-x-6">
        <!-- Wishlist -->
        <a href="wishlist.html" class="relative text-gray-400 hover:text-primary" aria-label="Go to Wishlist">
          <div class="w-6 h-6 flex items-center justify-center">
            <i class="ri-heart-line ri-lg" aria-hidden="true"></i>
          </div>
          <span id="wishlist-count" class="absolute -top-1 -right-1 bg-primary text-black text-xs rounded-full w-4 h-4 flex items-center justify-center">0</span>
        </a>

        <!-- Cart -->
        <a href="cart.html" class="relative text-gray-400 hover:text-primary" aria-label="Go to Cart">
          <div class="w-6 h-6 flex items-center justify-center">
            <i class="ri-shopping-cart-line ri-lg" aria-hidden="true"></i>
          </div>
          <span id="cart-count" class="absolute -top-1 -right-1 bg-primary text-black text-xs rounded-full w-4 h-4 flex items-center justify-center">0</span>
        </a>

        <!-- User Profile/Login -->
        <a href="login.html" class="text-gray-400 hover:text-primary relative" aria-label="User Login" id="user-profile-link">
          <div class="w-6 h-6 flex items-center justify-center">
            <i class="ri-user-line ri-lg"></i>
          </div>
          <span id="user-name" class="absolute -top-1 -right-1 bg-primary text-black text-xs rounded-full w-4 h-4 flex items-center justify-center hidden"></span>
        </a>
      </div>
    </div>
  </header>

  <main class="py-10 px-4">
    <div class="container mx-auto">
      <div class="flex items-center mb-8">
        <h1 id="results-title" class="text-3xl font-bold text-white">Search Results</h1>
        <span id="results-count" class="ml-4 text-xl text-gray-400">0 items found</span>
      </div>

      <!-- Search Results -->
      <div id="search-results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <!-- Search results will be populated here dynamically -->
      </div>

      <!-- No Results Message -->
      <div id="no-results" class="hidden text-center py-16">
        <div class="text-5xl text-gray-600 mb-4">
          <i class="ri-search-line"></i>
        </div>
        <h2 class="text-2xl font-semibold text-white mb-2">No results found</h2>
        <p class="text-gray-400 mb-6">We couldn't find any items matching your search.</p>
        <a href="index.html" class="bg-primary text-black px-6 py-2 rounded-lg inline-block hover:bg-primary/90 transition-colors">
          Return to Home
        </a>
      </div>

      <!-- Loading Indicator -->
      <div id="loading-indicator" class="flex justify-center py-16">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary"></div>
      </div>
    </div>
  </main>

  <footer class="footer bg-gray-900 text-white py-6 mt-10">
    <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center">
      <p class="text-sm text-gray-400">Â© 2025 LuxeVault. All rights reserved.</p>
      <div class="flex space-x-4 mt-4 md:mt-0">
        <a href="#" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-primary">
          <i class="ri-facebook-fill"></i>
        </a>
        <a href="#" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-primary">
          <i class="ri-twitter-x-fill"></i>
        </a>
        <a href="#" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-primary">
          <i class="ri-instagram-fill"></i>
        </a>
      </div>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Parse search query from URL
      const urlParams = new URLSearchParams(window.location.search);
      const searchQuery = urlParams.get('q') || '';
      
      // Set search input value to current query
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.value = searchQuery;
        
        // Handle new search
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            window.location.href = `search.html?q=${encodeURIComponent(this.value)}`;
          }
        });
      }
      
      // Update page title and results heading
      document.title = `${searchQuery} - Search Results | LuxeVault`;
      
      // Function to update counts on page load
      function updateCounts() {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        
        // Update cart count to show total quantity
        const cartCount = cart.reduce((total, item) => total + (item.quantity || 1), 0);
        document.getElementById('cart-count').textContent = cartCount;
        
        // Update wishlist count
        document.getElementById('wishlist-count').textContent = wishlist.length;
      }
      
      // Function to create a product card
      function createProductCard(product) {
        return `
          <div class="product-card bg-gray-900 rounded-lg overflow-hidden shadow-md" data-product-id="${product.id}">
            <div class="relative">
              <img 
                src="${product.image || ''}" 
                alt="${product.name || 'Product'}" 
                class="w-full h-64 object-cover"
                onerror="this.onerror=null; this.src='https://via.placeholder.com/400x500?text=${encodeURIComponent(product.name || 'Product')}'"
              />
              <div class="absolute top-4 right-4">
                <button class="wishlist-btn w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center shadow-sm hover:text-primary transition-colors">
                  <i class="ri-heart-line"></i>
                </button>
              </div>
            </div>
            <div class="p-4">
              <div class="flex items-center mb-2">
                <div class="rating flex text-primary">
                  ${Array(5).fill().map((_, i) => 
                    i < Math.floor(product.rating || 0) ? '<i class="ri-star-fill"></i>' :
                    i === Math.floor(product.rating || 0) && (product.rating % 1 !== 0) ? '<i class="ri-star-half-fill"></i>' :
                    '<i class="ri-star-line"></i>'
                  ).join('')}
                </div>
                <span class="text-xs text-gray-500 ml-2">(${product.reviews || 0})</span>
              </div>
              <h3 class="font-medium mb-1 text-white">${product.name || 'Unnamed Product'}</h3>
              <p class="text-sm text-gray-500 mb-3">${product.category || 'Uncategorized'}</p>
              <div class="flex justify-between items-center">
                <span class="font-bold text-lg text-primary">$${typeof product.price === 'number' ? product.price.toFixed(2) : product.price || '0.00'}</span>
                <button class="add-to-cart bg-primary text-black w-10 h-10 rounded-full flex items-center justify-center hover:bg-primary/90">
                  <i class="ri-shopping-cart-line"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }
      
      // Function to perform search
      async function performSearch() {
        if (!searchQuery) {
          document.getElementById('loading-indicator').classList.add('hidden');
          document.getElementById('no-results').classList.remove('hidden');
          document.getElementById('results-title').textContent = 'All Products';
          return;
        }
        
        try {
          // Fetch all products
          const response = await fetch('/api/products');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const products = await response.json();
          
          if (!Array.isArray(products)) {
            throw new Error('Invalid data format received');
          }
          
          // Filter products based on search query
          const query = searchQuery.toLowerCase();
          const filteredProducts = products.filter(product => {
            return (
              (product.name && product.name.toLowerCase().includes(query)) ||
              (product.category && product.category.toLowerCase().includes(query)) ||
              (product.description && product.description.toLowerCase().includes(query))
            );
          });
          
          // Update results count
          document.getElementById('results-count').textContent = `${filteredProducts.length} items found`;
          
          // Hide loading indicator
          document.getElementById('loading-indicator').classList.add('hidden');
          
          // Display results or no results message
          if (filteredProducts.length > 0) {
            const searchResultsContainer = document.getElementById('search-results');
            searchResultsContainer.innerHTML = filteredProducts.map(product => createProductCard({
              ...product,
              price: parseFloat(product.price),
              rating: parseFloat(product.rating) || 0,
              reviews: parseInt(product.reviews) || 0
            })).join('');
            
            // Initialize event listeners for the product cards
            initializeProductCards();
          } else {
            document.getElementById('no-results').classList.remove('hidden');
          }
        } catch (error) {
          console.error('Error performing search:', error);
          document.getElementById('loading-indicator').classList.add('hidden');
          document.getElementById('search-results').innerHTML = `
            <div class="col-span-full text-center">
              <p class="text-red-500">Error loading results. Please try again later.</p>
            </div>
          `;
        }
      }
      
      // Function to generate a stable product ID
      function generateProductId(productData) {
        return btoa(productData.name + productData.price).replace(/[^a-zA-Z0-9]/g, '');
      }
      
      // Function to safely get text content from an element
      function safeGetText(parent, selector) {
        const element = parent.querySelector(selector);
        return element ? element.textContent : '';
      }
      
      // Function to safely get HTML content from an element
      function safeGetHTML(parent, selector) {
        const element = parent.querySelector(selector);
        return element ? element.innerHTML : '';
      }
      
      // Function to safely get image source
      function safeGetImageSrc(parent) {
        const img = parent.querySelector('img');
        return img ? img.src : '';
      }
      
      // Function to get product data from a product card
      function getProductDataFromCard(productCard) {
        if (!productCard) return null;
        
        // Prefer actual DB product ID from data attribute
        const dbId = productCard.getAttribute('data-product-id');
        const productData = {
          name: safeGetText(productCard, 'h3'),
          price: safeGetText(productCard, '.font-bold.text-lg'),
          image: safeGetImageSrc(productCard),
          category: safeGetText(productCard, '.text-sm.text-gray-500.mb-3'),
          rating: safeGetHTML(productCard, '.rating'),
          reviews: safeGetText(productCard, '.text-xs.text-gray-500.ml-2'),
          quantity: 1
        };
        
        // Only return product data if we have at least a name and price
        if (productData.name && productData.price) {
          // Use DB id when available, otherwise fallback to generated ID
          productData.id = dbId ? parseInt(dbId, 10) : generateProductId(productData);
          return productData;
        }
        return null;
      }
      
      // Function to initialize product card event listeners
      function initializeProductCards() {
        // Make product cards clickable to view details
        document.querySelectorAll('.product-card').forEach(card => {
          card.style.cursor = 'pointer';
          card.addEventListener('click', function(e) {
            if (e.target.closest('.add-to-cart') || e.target.closest('.wishlist-btn')) {
              return; // Don't navigate if clicking on buttons
            }
            
            const productData = getProductDataFromCard(card);
            if (!productData) return;
            
            const params = new URLSearchParams({
              id: productData.id,
              name: productData.name,
              price: productData.price,
              image: productData.image,
              category: productData.category,
              rating: productData.rating,
              reviews: productData.reviews
            });
            
            window.location.href = `product.html?${params.toString()}`;
          });
        });
        
        // Add wishlist functionality
        document.querySelectorAll('.wishlist-btn').forEach(button => {
          button.addEventListener('click', function(e) {
            e.stopPropagation();
            const productCard = button.closest('.product-card');
            const productData = getProductDataFromCard(productCard);
            
            if (!productData) return;
            
            let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
            const existingProductIndex = wishlist.findIndex(item => item.id === productData.id);
            
            if (existingProductIndex !== -1) {
              wishlist.splice(existingProductIndex, 1);
              button.querySelector('i').classList.remove('ri-heart-fill', 'text-primary');
              button.querySelector('i').classList.add('ri-heart-line');
            } else {
              wishlist.push(productData);
              button.querySelector('i').classList.remove('ri-heart-line');
              button.querySelector('i').classList.add('ri-heart-fill', 'text-primary');
            }
            
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            updateCounts();
          });
        });
        
        // Add cart functionality
        document.querySelectorAll('.add-to-cart').forEach(button => {
          button.addEventListener('click', function(e) {
            e.stopPropagation();
            const productCard = button.closest('.product-card');
            const productData = getProductDataFromCard(productCard);
            
            if (!productData) return;
            
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const existingProductIndex = cart.findIndex(item => item.id === productData.id);
            
            if (existingProductIndex !== -1) {
              cart[existingProductIndex].quantity += 1;
            } else {
              cart.push(productData);
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCounts();
            
            // Show toast notification
            showToast('Item added to cart');
          });
        });
        
        // Check if any products are already in wishlist and update UI
        const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        document.querySelectorAll('.product-card').forEach(card => {
          const productId = card.getAttribute('data-product-id');
          const isInWishlist = wishlist.some(item => item.id == productId);
          
          if (isInWishlist) {
            const wishlistBtn = card.querySelector('.wishlist-btn i');
            if (wishlistBtn) {
              wishlistBtn.classList.remove('ri-heart-line');
              wishlistBtn.classList.add('ri-heart-fill', 'text-primary');
            }
          }
        });
      }
      
      // Function to show toast messages
      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-0 opacity-100 z-50';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // Animate out after 3 seconds
        setTimeout(() => {
          toast.classList.add('translate-y-2', 'opacity-0');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
      
      // Check login status and update UI
      function checkLoginStatus() {
        fetch('/api/auth/check-login', {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Accept': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          const userProfileLink = document.getElementById('user-profile-link');
          const userNameSpan = document.getElementById('user-name');
          
          if (data.loggedIn && data.username) {
            // User is logged in
            userProfileLink.href = 'profile.html';
            userNameSpan.textContent = data.username.charAt(0).toUpperCase();
            userNameSpan.classList.remove('hidden');
            
            // Update the icon to show logged in state
            const userIcon = userProfileLink.querySelector('.ri-user-line');
            if (userIcon) {
              userIcon.classList.remove('ri-user-line');
              userIcon.classList.add('ri-user-fill');
            }
            
            // Store login status
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('username', data.username);
          } else {
            // User is not logged in (guest)
            userProfileLink.href = 'login.html';
            userNameSpan.classList.add('hidden');
            
            // Update the icon to show logged out state
            const userIcon = userProfileLink.querySelector('.ri-user-fill, .ri-user-line');
            if (userIcon) {
              userIcon.classList.remove('ri-user-fill');
              userIcon.classList.add('ri-user-line');
            }
            
            // Clear login status
            localStorage.setItem('isLoggedIn', 'false');
            localStorage.removeItem('username');
          }
        })
        .catch(error => {
          console.error('Error checking login status:', error);
        });
      }
      
      // Initialize page
      updateCounts();
      checkLoginStatus();
      performSearch();
    });
  </script>
</body>
</html> 